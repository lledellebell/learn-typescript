name: 'Create Algorithm Problem PR with Code Check (TS/JS)'

on:
  workflow_dispatch:
    inputs:
      problemTitle:
        description: 'ë¬¸ì œ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”'
        required: true
      problemLink:
        description: 'ë¬¸ì œ ë§í¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”'
        required: true
      solutionApproach:
        description: 'í’€ì´ ë°©ë²•ì„ ê°„ë‹¨íˆ ì„¤ëª…í•˜ì„¸ìš”'
        required: true
      code:
        description: 'í’€ì´ ì½”ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš” (TypeScript ë˜ëŠ” JavaScript)'
        required: true
      language:
        description: 'ì½”ë“œ ì–¸ì–´ë¥¼ ì„ íƒí•˜ì„¸ìš” (javascript ë˜ëŠ” typescript)'
        required: true
        default: 'javascript'
        options:
          - javascript
          - typescript
      timeComplexity:
        description: 'ì‹œê°„ ë³µì¡ë„ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: O(n))'
        required: true
      spaceComplexity:
        description: 'ê³µê°„ ë³µì¡ë„ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: O(1))'
        required: true
      feedbackRequest:
        description: 'ì½”ë“œì— ëŒ€í•œ í”¼ë“œë°± ìš”ì²­ ì‚¬í•­ì„ ì…ë ¥í•˜ì„¸ìš”'
        required: false
      additionalQuestions:
        description: 'ì¶”ê°€ ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”'
        required: false

jobs:
  create-dependabot-pr:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Validate Code Syntax
        id: validate-code
        run: |
          echo "${{ github.event.inputs.code }}" > solution.${{ github.event.inputs.language === 'typescript' && 'ts' || 'js' }}
          if [ "${{ github.event.inputs.language }}" == "typescript" ]; then
            npx tsc --noEmit solution.ts
          else
            node -c solution.js
          fi
        shell: bash
      - name: Check Syntax Result
        if: failure()
        run: |
          echo "ì½”ë“œì— ë¬¸ë²• ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤. í™•ì¸ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
          exit 1

      - name: Create Algorithm Problem PR
        id: create-pr
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const problemTitle = '${{ github.event.inputs.problemTitle }}';
            const problemLink = '${{ github.event.inputs.problemLink }}';
            const solutionApproach = '${{ github.event.inputs.solutionApproach }}';
            const code = '${{ github.event.inputs.code }}';
            const language = '${{ github.event.inputs.language }}';
            const timeComplexity = '${{ github.event.inputs.timeComplexity }}';
            const spaceComplexity = '${{ github.event.inputs.spaceComplexity }}';
            const feedbackRequest = '${{ github.event.inputs.feedbackRequest || "ì—†ìŒ" }}';
            const additionalQuestions = '${{ github.event.inputs.additionalQuestions || "ì—†ìŒ" }}';
            const prBody = `
              ğŸ“ **ë¬¸ì œ ì„¤ëª…**
              ë¬¸ì œ ë§í¬: [${problemLink}](${problemLink})
              
              ğŸ’¡ **í’€ì´ ë°©ë²•**
              ${solutionApproach}
              
              ğŸ§‘â€ğŸ’» **ì½”ë“œ (${language})**
              \`\`\`${language}
              ${code}
              \`\`\`
              
              ğŸ“Š **ì‹œê°„ ë° ê³µê°„ ë³µì¡ë„**
              - ì‹œê°„ ë³µì¡ë„: ${timeComplexity}
              - ê³µê°„ ë³µì¡ë„: ${spaceComplexity}
              
              ğŸ™‹â€â™‚ï¸ **ìš”ì²­ ì‚¬í•­**
              ${feedbackRequest}
              
              ğŸ¤” **ì¶”ê°€ ì§ˆë¬¸**
              ${additionalQuestions}
            `;

            const branchName = `dependabot/algorithm${Date.now()}`;

            // ìƒˆ ë¸Œëœì¹˜ ìƒì„±
            await github.rest.git.createRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `refs/heads/${branchName}`,
              sha: context.sha,
            });

            // ë¸Œëœì¹˜ì— ìƒˆë¡œìš´ íŒŒì¼ ìƒì„±
            const filePath = `algorithm/**/${problemTitle.replace(/ /g, '_')}.${language === 'typescript' ? 'ts' : 'js'}`;
            const fileContent = Buffer.from(prBody).toString('base64');

            await github.rest.repos.createOrUpdateFileContents({
              owner: context.repo.owner,
              repo: context.repo.repo,
              path: filePath,
              message: `${problemTitle}`,
              content: fileContent,
              branch: branchName,
            });

            // í’€ë¦¬í€˜ìŠ¤íŠ¸ ìƒì„±
            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `${problemTitle}`,
              head: branchName,
              base: 'master',
              body: prBody,
            });

            return pr.data.number;
      - name: Add Labels to PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = ${{ steps.create-pr.outputs.result }};
            const language = '${{ github.event.inputs.language }}';

            // ì–¸ì–´ì— ë”°ë¼ ë¼ë²¨ ì¶”ê°€
            const labels = [language === 'typescript' ? 'TypeScript' : 'JavaScript'];

            // ì‹œê°„/ê³µê°„ ë³µì¡ë„ í‰ê°€ì— ë”°ë¥¸ ë¼ë²¨ ì¶”ê°€
            const timeComplexity = '${{ github.event.inputs.timeComplexity }}';
            const spaceComplexity = '${{ github.event.inputs.spaceComplexity }}';

            if (timeComplexity.includes('O(1)')) {
              labels.push('ì‹œê°„ ë³µì¡ë„: ìƒìˆ˜ ì‹œê°„');
            } else if (timeComplexity.includes('O(n)')) {
              labels.push('ì‹œê°„ ë³µì¡ë„: ì„ í˜• ì‹œê°„');
            } else if (timeComplexity.includes('O(n^2)')) {
              labels.push('ì‹œê°„ ë³µì¡ë„: ì´ì°¨ ì‹œê°„');
            } else {
              labels.push('ì‹œê°„ ë³µì¡ë„: ê¸°íƒ€');
            }

            if (spaceComplexity.includes('O(1)')) {
              labels.push('ê³µê°„ ë³µì¡ë„: ìƒìˆ˜ ê³µê°„');
            } else if (spaceComplexity.includes('O(n)')) {
              labels.push('ê³µê°„ ë³µì¡ë„: ì„ í˜• ê³µê°„');
            } else {
              labels.push('ê³µê°„ ë³µì¡ë„: ê¸°íƒ€');
            }

            // PRì— ë¼ë²¨ ì¶”ê°€
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: labels,
            });
